<%- include('header') -%>
<div class="layout">
  <aside class="layout-sidebar">
    <nav>
      <ul>
        <% if (!locals.type || locals.type === 'FOLDER') { %>
        <li>
          <sl-dialog label="New Folder" class="dialog-focus">
            <form action="/new" method="post">
              <input type="hidden" name="parentId" value="<%= locals.id || null %>"></input>
              <sl-input name="name" label="Name" autofocus placeholder=""></sl-input>
              </br>
              <sl-button type="submit" slot="footer" variant="primary">Create Folder</sl-button>
            </form>
          </sl-dialog>
          <sl-button class="card-btn">
            <sl-icon class="card-icon"name="folder-plus"></sl-icon><span>New Folder</span>
          </sl-button>
        </li>
          <% } %>
        <li><a href="/login">Login</a></li>
        <li><a href="/register">Register</a></li>
      </ul>
    </nav>
    <sl-tree>
      <% function renderTree(items) { %>
        <% items.forEach(item => { %>
          <sl-tree-item 
          <%= item.id === locals.id && "selected" %> 
          <%= locals.pathSegments && locals.pathSegments.includes(item.name) && "expanded" %>
          >
          <a href="/<%= item.id %>"><%= item.name %></a>
            <% if (item.childEntities && item.childEntities.length > 0) { %>
              <%= renderTree(item.childEntities) %>
            <% } %>
          </sl-tree-item>
        <% }); %>
      <% } %>
    
      <%= renderTree(locals.folders) %>
    </sl-tree>
  </aside>
  <main class="layout-main">
    <% if (locals.currentUser) { %>
      <% console.dir(locals.pathSegments) %>
      <h2 class="title">Welcome back <%= currentUser.username %></h2>
      <sl-breadcrumb>
        <sl-breadcrumb-item href="/"><%= `${currentUser.username}'s files` %></sl-breadcrumb-item>
        <% if (locals?.pathSegments?.length > 0) { 
          %>
          
          <% 
          locals.pathSegments.forEach((segment) => {  %>
            <sl-breadcrumb-item href="<%= segment %>"><%= segment %></sl-breadcrumb-item>
        <% }) %>
        <% } %>
      </sl-breadcrumb>
        <form action="/upload" enctype="multipart/form-data" method="post">
          <div class="form-group">
            <input type="file" name="uploaded_file"></input>
            <input type="hidden" name="path" value="<%= locals?.path %>"></input>
            <sl-button type="submit" value="Get me the stats!">Upload</sl-button>
          </div>
        </form>
        <br />
        <div class='grid-container'>
          <div class="grid-row grid-header">
            <div class="grid-col">Name</div>
            <div class="grid-col">Size</div>
            <div class="grid-col">Created</div>
          </div>
        <% for (var i = 0; i < files.length; i++) { 
          const icon = files[i].type === 'FILE' ? 'file-earmark' : 'folder'%>
          <button onclick="window.location.href='/<%= files[i].id %>'" class="btn grid-row">
              <div class="grid-col col-name">
                <sl-icon class="col-name-icon" name="<%= icon %>"></sl-icon>
                <small><%= files[i].name %></small>
              </div>
              <small class="grid-col"><%= files[i].size || "--"%></small>
              <small class="grid-col"><%= files[i].createdAt %></small>
          </button>
        <% } %>
          </div>
        </div>
      </div>
    <% } else { %>

    <% } %>
  </main>
</div>
<script>
  const dialog = document.querySelector('.dialog-focus');
  const input = dialog.querySelector('sl-input');
  const openButton = dialog.nextElementSibling;
  const closeButton = dialog.querySelector('sl-button[slot="footer"]');

  openButton.addEventListener('click', () => dialog.show());
  closeButton.addEventListener('click', () => dialog.hide());
</script>
<%- include('footer') -%>